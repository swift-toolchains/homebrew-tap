name: swift-toolchains ci

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  swift-toolchains:
    runs-on: macos-13
    steps:
      - name: "Swift 5.9 Ubuntu 20.04 x86_64 cross-compile"
        run: |
          brew install tree
          brew install swift-toolchains/tap/spm-dest-5.9-x86_64-ubuntu20.04
          swift package init --type executable --name clidemo59
          # the target name is wrong in the build destination script
          sed -I. 's;"target": "x86_64-unknown-linux";"target": "x86_64-unknown-linux-gnu";g' $(brew --prefix)/lib/swift/dst/x86_64-unknown-linux/swift-5.9-ubuntu20.04.xtoolchain/destination.json

          swift build \
              --destination $(brew --prefix)/lib/swift/dst/x86_64-unknown-linux/swift-5.9-ubuntu20.04.xtoolchain/destination.json \
              --static-swift-stdlib \
              -Xswiftc "-static-executable" || echo FAILED
          file .build/x86_64-unknown-linux-gnu/debug/clidemo59 || echo FAILED

      - name: "Swift 5.6 Ubuntu 20.04 x86_64 cross-compile"
        run: |
          brew install tree
          brew install swift-toolchains/tap/spm-dest-5.6-x86_64-ubuntu20.04
          swift package init --type executable --name clidemo56
          # the target name is wrong in the build destination script
          sed -I. 's;"target": "x86_64-unknown-linux";"target": "x86_64-unknown-linux-gnu";g' $(brew --prefix)/lib/swift/dst/x86_64-unknown-linux/swift-5.6-ubuntu20.04.xtoolchain/destination.json

          swift build \
              --destination $(brew --prefix)/lib/swift/dst/x86_64-unknown-linux/swift-5.6-ubuntu20.04.xtoolchain/destination.json \
              --static-swift-stdlib \
              -Xswiftc "-static-executable"
          file .build/x86_64-unknown-linux-gnu/debug/clidemo56

